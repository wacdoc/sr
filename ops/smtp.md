# Направите сопствени СМТП сервер за слање поште

## преамбула

СМТП може директно да купи услуге од добављача у облаку, као што су:

* [Амазон СЕС СМТП](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Али цлоуд пусх емаил](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Такође можете да направите сопствени сервер за пошту - неограничено слање, ниска укупна цена.

У наставку ћемо показати корак по корак како да изградимо сопствени сервер за пошту.

## Избор сервера

СМТП сервер са сопственим хостом захтева јавну ИП адресу са отвореним портовима 25, 456 и 587.

Често коришћени јавни облаци су подразумевано блокирали ове портове и можда их је могуће отворити издавањем радног налога, али је то ипак веома проблематично.

Препоручујем куповину од хоста који има отворене ове портове и подржава подешавање обрнутих имена домена.

Ево, препоручујем [Цонтабо](https://contabo.com) .

Цонтабо је хостинг провајдер са седиштем у Минхену, Немачка, основан 2003. године са веома конкурентним ценама.

Ако одаберете евро као валуту куповине, цена ће бити јефтинија (сервер са 8ГБ меморије и 4 ЦПУ-а кошта око 529 јуана годишње, а почетна инсталација је бесплатна годину дана).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Приликом поруџбине, напомените да `prefer AMD` и сервер са АМД ЦПУ-ом ће имати боље перформансе.

У наставку ћу узети Цонтабо-ов ВПС као пример да покажем како да направите сопствени сервер за пошту.

## Убунту системска конфигурација

Оперативни систем овде је Убунту 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Ако сервер на ссх-у прикаже `Welcome to TinyCore 13!` (као што је приказано на слици испод), то значи да систем још није инсталиран. Искључите ссх и сачекајте неколико минута да се поново пријавите.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

Када се појави `Welcome to Ubuntu 22.04.1 LTS` , иницијализација је завршена и можете наставити са следећим корацима.

### [Опционално] Иницијализујте развојно окружење

Овај корак је опциони.

Ради практичности, ставио сам инсталацију и системску конфигурацију убунту софтвера на [гитхуб.цом/вацтак/](https://github.com/wactax/ops.os/tree/main/ubuntu) опс.ос/трее/маин/убунту.

Покрените следећу команду да бисте инсталирали једним кликом.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Кинески корисници, користите следећу команду уместо тога, а језик, временска зона итд. ће бити аутоматски подешени.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Цонтабо омогућава ИПВ6

Омогућите ИПВ6 тако да СМТП може да шаље и е-пошту са ИПВ6 адресама.

уреди `/etc/sysctl.conf`

Измените или додајте следеће редове

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

Наставите са [водичем за контабо: Додавање ИПв6 везе на ваш сервер](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

Уредите `/etc/netplan/01-netcfg.yaml` , додајте неколико редова као што је приказано на слици испод (Цонтабо ВПС подразумевана конфигурациона датотека већ има ове редове, само их уклоните коментаре).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Затим `netplan apply` да би модификована конфигурација ступила на снагу.

Након што је конфигурација успешна, можете користити `curl 6.ipw.cn` да видите ипв6 адресу ваше спољне мреже.

## Клонирајте опс репозиторијума конфигурације

```
git clone https://github.com/wactax/ops.soft.git
```

## Генеришите бесплатан ССЛ сертификат за име вашег домена

Слање поште захтева ССЛ сертификат за шифровање и потписивање.

Користимо [ацме.сх](https://github.com/acmesh-official/acme.sh) за генерисање сертификата.

ацме.сх је аутоматизовани алат за потписивање сертификата отвореног кода,

Унесите складиште конфигурације опс.софт, покрените `./ssl.sh` и `conf` фолдер ће бити креиран у **горњем директоријуму** .

Пронађите свог ДНС провајдера на [ацме.сх днсапи](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) , уредите `conf/conf.sh` .

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Затим покрените `./ssl.sh 123.com` да бисте генерисали `123.com` и `*.123.com` сертификате за име вашег домена.

Прво покретање ће аутоматски инсталирати [ацме.сх](https://github.com/acmesh-official/acme.sh) и додати заказани задатак за аутоматско обнављање. Можете видети `crontab -l` , постоји таква линија као што следи.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Путања за генерисани сертификат је нешто попут `/mnt/www/.acme.sh/123.com_ecc。`

Обнављање сертификата ће позвати `conf/reload/123.com.sh` скрипту, уредите ову скрипту, можете додати команде као што је `nginx -s reload` да освежите кеш сертификата повезаних апликација.

## Направите СМТП сервер са цхаскуидом

[цхаскуид](https://github.com/albertito/chasquid) је СМТП сервер отвореног кода написан на Го језику.

Као замена за древне програме за сервере поште као што су Постфик и Сендмаил, цхаскуид је једноставнији и лакши за коришћење, а такође је лакши за секундарни развој.

Покрени `./chasquid/init.sh 123.com` ће бити инсталиран аутоматски једним кликом (замените 123.цом именом вашег домена за слање).

## Конфигуришите ДКИМ потпис е-поште

ДКИМ се користи за слање потписа е-поште како би се спречило да се писма третирају као нежељена пошта.

Након што се команда успешно покрене, од вас ће бити затражено да поставите ДКИМ запис (као што је приказано испод).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Само додајте ТКСТ запис у свој ДНС (као што је приказано испод).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Погледајте статус услуге и евиденције

 `systemctl status chasquid` Погледајте статус услуге.

Стање нормалног рада је као што је приказано на слици испод

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` или `journalctl -xeu chasquid` може да види евиденцију грешака.

## Обрнута конфигурација имена домена

Обрнуто име домена омогућава да се ИП адреса разреши у одговарајуће име домена.

Подешавање обрнутог имена домена може спречити да се е-пошта идентификује као нежељена пошта.

Када се е-маил прими, сервер који прима пошту ће извршити обрнуту анализу имена домена на ИП адреси сервера који шаље да би потврдио да ли сервер који шаље има важеће реверзно име домена.

Ако сервер који шаље нема обрнуто име домена или ако се обрнуто име домена не поклапа са ИП адресом сервера који шаље, сервер примаоца може препознати е-пошту као нежељену пошту или је одбити.

Посетите [хттпс://ми.цонтабо.цом/рднс](https://my.contabo.com/rdns) и конфигуришите као што је приказано у наставку

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Након подешавања обрнутог имена домена, не заборавите да конфигуришете резолуцију унапред за име домена ипв4 и ипв6 на сервер.

## Уредите име хоста цхаскуид.цонф

Измените `conf/chasquid/chasquid.conf` на вредност обрнутог имена домена.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Затим покрените `systemctl restart chasquid` да поново покренете услугу.

## Бацкуп цонф у гит спремиште

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

На пример, правим резервну копију фасцикле цонф у свом сопственом гитхуб процесу на следећи начин

Прво направите приватно складиште

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

Унесите цонф директоријум и пошаљите га у складиште

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Додај пошиљаоца

трцати

```
chasquid-util user-add i@wac.tax
```

Може додати пошиљаоца

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Проверите да ли је лозинка исправно постављена

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Након додавања корисника, `chasquid/domains/wac.tax/users` ће бити ажурирани, не заборавите да га пошаљете у складиште.

## ДНС додаје СПФ запис

СПФ ( Сендер Полици Фрамеворк ) је технологија за верификацију е-поште која се користи за спречавање преваре путем е-поште.

Он проверава идентитет пошиљаоца поште провером да ли се ИП адреса пошиљаоца поклапа са ДНС записима имена домена за који тврди да јесте, спречавајући преваранте да шаљу лажне е-поруке.

Додавање СПФ записа може спречити да се е-пошта идентификује као нежељена што је више могуће.

Ако ваш сервер имена домена не подржава СПФ тип, само додајте запис типа ТКСТ.

На пример, СПФ за `wac.tax` је следећи

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

СПФ за `_spf.wac.tax`

`v=spf1 a:smtp.wac.tax ~all`

Имајте на уму да сам овде `include:_spf.google.com` , то је зато што ћу касније конфигурисати `i@wac.tax` као адресу за слање у Гоогле поштанском сандучету.

## ДНС конфигурација ДМАРЦ

ДМАРЦ је скраћеница од (Домен-басед Мессаге Аутхентицатион, Репортинг & Цонформанце).

Користи се за снимање СПФ одбијања (можда узрокованих грешкама у конфигурацији или се неко други претвара да сте ви да би слао нежељену пошту).

Додај ТКСТ запис `_dmarc` ,

Садржај је следећи

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Значење сваког параметра је следеће

### п (Политика)

Означава како поступати са имејловима који не успеју да провере СПФ (Сендер Полици Фрамеворк) или ДКИМ (ДомаинКеис Идентифиед Маил). Параметар п може да се подеси на једну од три вредности:

* ништа: Не предузима се никаква радња, само се резултат верификације враћа пошиљаоцу путем механизма за пријављивање путем е-поште.
* Карантин: Ставите пошту која није прошла верификацију у фолдер нежељене поште, али неће директно одбити пошту.
* одбацити: Директно одбацити е-пошту која није успела да потврди.

### фо (Опције грешке)

Одређује количину информација које враћа механизам извештавања. Може се подесити на једну од следећих вредности:

* 0: Извештај о резултатима провере ваљаности за све поруке
* 1: Пријавите само поруке које нису успеле у верификацији
* д: Пријавите само грешке у верификацији имена домена
* с: пријави само грешке СПФ верификације
* л: Пријавите само грешке у ДКИМ верификацији

### руа & руф

* руа (УРИ за извештавање за збирне извештаје): адреса е-поште за примање збирних извештаја
* руф (УРИ за извештавање за форензичке извештаје): адреса е-поште за примање детаљних извештаја

## Додајте МКС записе да бисте прослеђивали е-пошту у Гоогле Маил

Пошто нисам могао да пронађем бесплатно корпоративно поштанско сандуче које подржава универзалне адресе (Цатцх-Алл, може да прими било коју е-пошту послату на име овог домена, без ограничења на префиксе), користио сам цхаскуид да проследим све е-поруке у своје Гмаил поштанско сандуче.

**Ако имате сопствено плаћено пословно поштанско сандуче, немојте мењати МКС и прескочите овај корак.**

Уредите `conf/chasquid/domains/wac.tax/aliases` , подесите поштанско сандуче за прослеђивање

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` означава све е-поруке, `i` је префикс адресе е-поште корисника који шаље поруку креиран изнад. Да би прослеђивао пошту, сваки корисник треба да дода линију.

Затим додајте МКС запис (показујем директно на адресу обрнутог имена домена овде, као што је приказано у првом реду на слици испод).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Када се конфигурација заврши, можете да користите друге адресе е-поште да шаљете е-пошту на `i@wac.tax` и `any123@wac.tax` да бисте видели да ли можете да примате е-пошту у Гмаил-у.

Ако није, проверите цхаскуид дневник ( `grep chasquid /var/log/syslog` ).

## Пошаљите е-поруку на и@вац.так са Гоогле Маил-ом

Након што је Гоогле Маил примио пошту, наравно, надао сам се да ћу одговорити са `i@wac.tax` уместо и.вац.так@гмаил.цом.

Посетите [хттпс://маил.гоогле.цом/маил/у/1/#сеттингс/аццоунтс](https://mail.google.com/mail/u/1/#settings/accounts) и кликните на „Додај другу адресу е-поште“.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Затим унесите верификациони код примљен путем е-поште на коју је прослеђен.

Коначно, може се поставити као подразумевана адреса пошиљаоца (заједно са могућношћу одговора са истом адресом).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

На овај начин смо завршили успостављање СМТП сервера поште и истовремено користимо Гоогле Маил за слање и примање мејлова.

## Пошаљите пробну е-пошту да проверите да ли је конфигурација успешна

Унесите `ops/chasquid`

Покрените `direnv allow` да инсталирате зависности (диренв је инсталиран у претходном процесу иницијализације са једним кључем и кука је додата у љуску)

онда трчи

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Значење параметара је следеће

* корисник: СМТП корисничко име
* пасс: СМТП лозинка
* до: примаоца

Можете послати пробну е-пошту.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Препоручује се да користите Гмаил за пријем пробних е-порука да бисте проверили да ли су конфигурације успешне.

### ТЛС стандардно шифровање

Као што је приказано на слици испод, постоји ова мала брава, што значи да је ССЛ сертификат успешно омогућен.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Затим кликните на „Прикажи оригиналну е-пошту“

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### ДКИМ

Као што је приказано на слици испод, Гмаил оригинална страница поште приказује ДКИМ, што значи да је ДКИМ конфигурација успешна.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Проверите Рецеивед у заглављу оригиналне е-поште и видећете да је адреса пошиљаоца ИПВ6, што значи да је ИПВ6 такође успешно конфигурисан.
